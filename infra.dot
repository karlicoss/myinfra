# http://www.graphviz.org/content/cluster
# TODO https://www.graphviz.org/doc/info/colors.html
// https://www.rff.com/flowchart_shapes.php
// https://www.graphviz.org/doc/info/shapes.html


# echo 'infra.dot' | entr dot -T svg infra.dot -o infra.svg

digraph G {
  # https://stackoverflow.com/a/2012106/706389
  compound=true;

  // concatenate=true; // eh, doesn't seem to work..

  node [shape="box"];
  // rankdir="LR";

  rank=max; // TODO eh?

  // TODO not sure which rang to choose?


subgraph cluster_phone {
  label="Phone";
  node [shape=point];

  gps;

  app_endomondo;
  app_bluemaestro;
  app_jawbone;
  // phone;
}


subgraph cluster_google {
  label="Google";
  style="dashed,rounded";
  color=orange;
  // rankdir="TB";  // eh? not working..

  "Google Location";
  # TODO "timeline" can be treated as poor man's api??
  "Google Location" -> "Takeout";
}

gps -> "Google Location";

# TODO distinguish 'device' and 'service'; display legend

# Demonstrates how much indirection is there if you want to own your data


# TODO eh, these extra nodes are useles..

subgraph cluster_twittercom {
	label="Twitter";
	style="dashed,rounded";
	color=lightblue;
	// node [style=filled,color=white];

  tw_export;
  tw_api [label=API];
	// a0 -> a1 -> a2 -> a3;
}


subgraph cluster_vkcom {
  label="VK.com";
  style="dashed,rounded";

  vk_api [label=API];
}

// TODO trivial connections (e.g. twitter phone app -> twitter are omitted)
// TODO should they be though?



// TODO phone location data
// subgraph cluster_wahoo {
//   label="Wahoo";
//   style=filled;
wahoo [label="Wahoo\n(HR monitor)"];
// }

wahoo -> app_endomondo [label=bluetooth];


jawbone [label="Jawbone\n(sleep tracker)"];

jawbone -> app_jawbone [label=bluetooth];

// subgraph cluster_bluemaestro {
//   label="Bluemaestro";
//   style=filled;
//   bluemaestro;
// }
// TODO links?
bluemaestro [label="Bluemaestro\n(environment\nsensor)"];

bluemaestro -> app_bluemaestro [label=bluetooth];
// TODO pehraps need arrows _through_ phone. e.g. via invisible dots or something

subgraph cluster_endomondo {
	label="Endomondo";
  style="dashed,rounded";
  color=green;
  end_api [label=API];
	// node [style=filled];
	// b0 -> b1 -> b2 -> b3;
}

app_endomondo -> end_api; // TODO

// TODO jawbone device? (useless?)

# TODO indicate frequencies?

// TODO kindle (unused)

subgraph cluster_kobo {
  label="Kobo reader";
  style=filled;
  color=gray;
  kobo_sqlite [label=sqlite];
}

# TODO also could show how data gets _into_ the services, i.e. clients?
subgraph cluster_instapaper {
  label="Instapaper";
  style="dashed,rounded";
  color=lightgray;

  ip_api [label=API];
}

# TODO demonstrate that it's dead
subgraph cluster_jawbone {
  label="Jawbone\n(dead)";
  style="dashed,rounded";
  color=orange;

  jb_api [label=API];
}


app_jawbone -> jb_api;


subgraph cluster_emfit {
  label="Emfit\n(sleep tracker)";
  style=filled;
  color=grey;


  // TODO dot?
  emfit [shape=point];

  emfit_wifi [label="wifi\n(local API))"];
}


subgraph cluster_emfit_cloud {
  label="Emfit";
  style="dashed,rounded";
  emfit_api [label="API"];
}

emfit -> emfit_api [label=internet];

// TODO if I draw an edge from UI to phone.... gonna be fun



# TODO hmm. how to still draw a frame around it?
subgraph cluster_pipelines {
  label="Pipelines";
  style=filled;
  color=coral;

  # TODO more like 'cluster_fs'?
  # meh
  subgraph cluster_exports {
    node [shape=cylinder];
    label="Filesystem";
    rank=same;
    style=dashed;
    color=black;

    exp_jawbone;
    exp_kobo;
    exp_takeouts;
    # TODO mention kython.ktakeout??
    exp_twitter_archives;

    exp_emfit;
    exp_twitter;
    exp_vk;

    exp_endomondo;
    exp_instapaper;

    data_weight;
    data_blood;
    # TODO mention manual inputs for these..

    exp_bluemaestro;

    exp_point [shape=point];
  }


  twexport;
  endoexport;
  ipexport;

  jbexport [shape=cds]; // TODO cross out maybe?
  vkexport [shape=cds];

  # TODO eh, figure out better shape for 'dead'
  # TODO perhaps makes more sense to mark edge?

  tw_manual[shape=invtrapezium];
  takeout  [shape=invtrapezium];

  "Takeout"   -> takeout     -> exp_takeouts;
  tw_export   -> tw_manual   -> exp_twitter_archives;
  tw_api      -> twexport    -> exp_twitter;
  vk_api      -> vkexport    -> exp_vk;
  jb_api      -> jbexport    -> exp_jawbone;
  emfit_api   -> emfitexport -> exp_emfit;

  end_api     -> endoexport -> exp_endomondo;
  ip_api      -> ipexport   -> exp_instapaper;

  kobo_sqlite -> kobuddy    -> exp_kobo;

  app_bluemaestro -> exp_bluemaestro [label=syncthing];


  mypkg;
  # TODO eh, not sure about that
  // subgraph cluster_mypkg {
  //   label="my. ";
  //   style=dashed;
  //   mypkg;
  //   "sleep.py";
  //    "tweets.py";
  // }

  exp_takeouts                    -> mypkg [label="location data"];
  exp_twitter_archives            -> mypkg;
  exp_jawbone                     -> mypkg;
  # TODO note how this edge is still active despite the fact that jbexport isn't working anymore
  exp_emfit                       -> mypkg;
  # TODO as you can see not everything has data access layer
  # so there is still something to work on


  exp_vk                          -> mypkg;
  exp_twitter    -> dal_twitter   -> mypkg;
  exp_endomondo  -> dal_endomondo -> mypkg;
  exp_instapaper -> dal_ip        -> mypkg;

  exp_kobo       -> dal_kobuddy   -> mypkg;
  data_weight                     -> mypkg; # TODO mention orgparse
  data_blood                      -> mypkg; # TODO mention orgparse

}

// TODO browser history?

# TODO display google home and mention how useless it is

# TODO motivation for blood
# I'm planning on tracking this for several decades, so providers will change

# TODO could expand mypkg into separate files as well to demonstrate which data is consumed by what?

# TODO mypkg is somewhat specific to my needs
# TODO highlight that it's easy to hook to DAL 

# TODO distinguish manual and automatic nodes?
# TODO instead have twexport on edges? ultimately not that much difference..

# TODO position borg above

# TODO indicate stuff that is 'inactive' and not used anymore
# TODO e.g. vk.com pipelines

# TODO svg output with links
subgraph cluster_backups {
  label="Backups";

  borg;

# exp_kobo             -> borg [style=dashed];
# exp_twitter_archives -> borg [style=dashed];
# exp_twitter          -> borg [style=dashed];
# exp_endomondo        -> borg [style=dashed];
}

exp_point -> borg [ltail=cluster_exports];

# TODO mark edges that use cachew?

subgraph cluster_orger {
  label=Orger;
  module_twitter;
  module_kobo;
  module_instapaper;

  module_kobo2org;
  module_ip2org;

  orger_point [shape=point];
}
mypkg -> module_twitter;
mypkg -> module_kobo;
mypkg -> module_instapaper;

# TODO these are read only; contribute to search
module_twitter    -> twitter_org;
module_kobo       -> kobo_org;
module_instapaper -> instapaper_org;

module_kobo2org   -> org_agenda;
module_ip2org     -> org_agenda;

org_agenda -> emacs;

# TODO cloudmacs?
# TODO arctee
# TODO link some of my blog posts? E.g. ones using endomondo



subgraph cluster_ui {
  label="User interfaces";
  style=filled;
  color=pink;

  emacs;
  browser;
  ipython;
}

mypkg -> ipython;

mypkg -> timeline;

mypkg -> dashboard [label="Calendar"];
mypkg -> dashboard [label="Sleep"];
mypkg -> dashboard [label="Exercise"];
# TODO perhaps I need HR provider?
mypkg -> dashboard [label="Blood data"];
mypkg -> dashboard [label="Weight"];

# TODO distinguish regular manual tasks and 'only once' manual tasks
# perhaps highlight regular manual with red
# TODO kobo -- semi manual?

promnesia [shape=star];


mypkg -> promnesia [label="FB messenger"];
exp_takeouts -> promnesia [label="Google Takeout"];
mypkg -> promnesia [label="Hypothes.is" ];
mypkg -> promnesia [label="Instapaper"  ];
mypkg -> promnesia [label="Org files"   ];
mypkg -> promnesia [label="Pocket"      ];
mypkg -> promnesia [label="Reddit"      ];
# TODO show missing links? like HN
mypkg -> promnesia [label="Telegram"    ];
mypkg -> promnesia [label="Twitter"     ];
mypkg -> promnesia [label="VK"          ];


promnesia -> browser;
timeline  -> browser;
dashboard -> browser;


{
  kobo_org,
  twitter_org,
  instapaper_org
} -> emacs;

# TODO I guess it's nice to mention where I mention certain bits of infrastructure?

# TODO style blog posts differently?
# TODO position below all

subgraph cluster_blog {
  label="Blog posts";
  blog_hb_kcals [
    label="Making sense of Endomondo's calorie estimation";
    URL="https://beepb00p.xyz/heartbeats_vs_kcals.html";
  ];
  blog_mypkg [
    label="my. package";
    URL="https://beepb00p.xyz/mypkg.html";
  ];
  blog_orger;
  blog_takeout_data_gone;
}
# TODO https://beepb00p.xyz/takeout-data-gone.html

# TODO use different line styles...
# TODO pipelines could link to sad state
orger_point -> blog_orger;
mypkg       -> blog_hb_kcals;
mypkg       -> blog_mypkg;
takeout     -> blog_takeout_data_gone;
// 

// TODO right. I think I need to add browser history and that's it. publish straigh away after that
// TODO ok, that's ki

}
